# 🔍 Product Search - Visual Quick Reference

## 🎯 Текущая архитектура (Phase 1)

```
┌────────────────────────────────────────────────────────────────┐
│  Клиент: "вагонка 6 метров класс АВ"                           │
└────────────────────────────────────────────────────────────────┘
                           ↓
┌────────────────────────────────────────────────────────────────┐
│  ReAct Agent                                                    │
│  🤔 Thought: "Клиент ищет вагонку, нужен поиск по каталогу"    │
└────────────────────────────────────────────────────────────────┘
                           ↓
┌────────────────────────────────────────────────────────────────┐
│  Tool: search_products(query="вагонка 6м АВ", limit=20)        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 1️⃣ Redis Cache check: "1c:catalog:flat"                 │  │
│  │    ✅ HIT → 861 товар loaded                             │  │
│  │    ❌ MISS → GET /GetGroups → cache 1h                   │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │ 2️⃣ Normalize: "вагонка 6м АВ" → "вагонка 6000 ав"      │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │ 3️⃣ Extract keywords: ["вагонка", "6000", "ав"]          │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │ 4️⃣ BM25-like scoring:                                   │  │
│  │    For each item in catalog:                             │  │
│  │      score = 0                                            │  │
│  │      for kw in keywords:                                  │  │
│  │        if exact_match → +10                               │  │
│  │        if partial_match → +5                              │  │
│  │      if all_keywords_found → +3                           │  │
│  │      score -= len(name) * 0.01  # короче = лучше         │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │ 5️⃣ Sort by score DESC → Top-20                          │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │ 6️⃣ Extract unique group_codes from Top-20               │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │ 7️⃣ POST /GetItems → Fetch PRICES for these groups      │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │ 8️⃣ Enrich items with prices → Return formatted         │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
                           ↓
┌────────────────────────────────────────────────────────────────┐
│  Agent receives:                                                │
│  "Найдено товаров: 8                                           │
│                                                                 │
│  1. Вагонка штиль 13х115х6000 класс АВ — 15,500₽              │
│     Код: 00-00010275                                           │
│  2. Вагонка штиль 13х140х6000 класс АВ — 17,200₽              │
│     Код: 00-00010177                                           │
│  3. Евровагонка 12,5х90х6000 класс АВ — 16,800₽               │
│     Код: 00-00010047"                                          │
└────────────────────────────────────────────────────────────────┘
                           ↓
┌────────────────────────────────────────────────────────────────┐
│  Agent                                                          │
│  🤔 Thought: "Нашел варианты, покажу топ-3 клиенту"           │
└────────────────────────────────────────────────────────────────┘
                           ↓
┌────────────────────────────────────────────────────────────────┐
│  Response to client:                                            │
│  "Да, у нас есть вагонка 6 метров класса АВ! Нашел 8 вариантов:│
│                                                                 │
│  1. **Вагонка штиль 13х115мм** - 15,500₽                       │
│  2. **Вагонка штиль 13х140мм** - 17,200₽                       │
│  3. **Евровагонка 12,5х90мм** - 16,800₽                        │
│                                                                 │
│  Какая ширина вас интересует?"                                 │
└────────────────────────────────────────────────────────────────┘
```

---

## ⚡ Performance

| Метрика | Значение | Комментарий |
|---------|----------|-------------|
| **Latency** | 50-200ms | 5ms keyword search + 50ms GetItems + network |
| **Cache Hit Rate** | 95%+ | GetGroups кэшируется 1 час |
| **Precision@5** | 80%+ | Топ-5 результатов релевантны |
| **Zero Results** | <10% | Менее 10% пустых ответов |

---

## 🔄 Agent Decision Flow

```
START
  ↓
[Сообщение от клиента]
  ↓
  ├─ "вагонка 6м" ──────────→ search_products()
  ├─ "доставка?" ───────────→ search_company_info("delivery")
  ├─ "код 00-00123" ────────→ get_product_details(["00-00123"])
  ├─ "хочу заказать" ───────→ collect_order_info()
  └─ "не нашел товар" ──────→ call_manager()
  ↓
[Observation от tool]
  ↓
  ├─ Товары найдены ────────→ Показать топ-5, спросить предпочтения
  ├─ Клиент выбрал ─────────→ get_product_details() → Детали
  ├─ Готов заказать ────────→ collect_order_info() → call_manager()
  └─ Ничего не нашлось ─────→ call_manager("товар не найден")
  ↓
END
```

---

## 📊 Data Flow

### GetGroups → Flat Catalog
```json
// INPUT: GET /GetGroups
{
  "groups": [
    {
      "название": "Вагонка штиль",
      "номенклатура": "00-00010036",
      "items": [
        {
          "номенклатура": "00-00010275",
          "название": "Вагонка штиль 13х115х6000 класс С"
        }
      ]
    }
  ]
}

// TRANSFORM: Flatten
[
  {
    "item_code": "00-00010275",
    "item_name": "Вагонка штиль 13х115х6000 класс С",
    "group_code": "00-00010036",
    "group_name": "Вагонка штиль"
  }
]

// CACHE: Redis
Key: "1c:catalog:flat"
TTL: 3600 seconds (1 hour)
Size: ~200KB (861 items)
```

### Query → Keywords
```
INPUT: "вагонка 6 метров класс АВ"
  ↓ normalize
"вагонка 6000 класс ав"
  ↓ extract_keywords
["вагонка", "6000", "класс", "ав"]
  ↓ remove stop words
["вагонка", "6000", "ав"]
```

### Scoring Example
```
Query: ["вагонка", "6000", "ав"]

Item 1: "Вагонка штиль стр. сух. хв. 13х115х6000 класс АВ"
  - "вагонка" exact match → +10
  - "6000" exact match → +10
  - "ав" exact match → +10
  - All keywords found → +3
  - Length penalty: -55 * 0.01 = -0.55
  = Score: 32.45 ✅ TOP

Item 2: "Вагонка штиль стр. сух. хв. 13х115х3000 класс АВ"
  - "вагонка" exact match → +10
  - "6000" NOT found → 0
  - "ав" exact match → +10
  - Length penalty: -55 * 0.01 = -0.55
  = Score: 19.45

Item 3: "Брус клееный стр. сух. хв. 150х150х6000 класс АВ"
  - "вагонка" NOT found → 0
  - "6000" exact match → +10
  - "ав" exact match → +10
  - Length penalty: -53 * 0.01 = -0.53
  = Score: 19.47
```

---

## 🎯 Success Criteria

### Functional Requirements
- ✅ Находит товары по типу ("вагонка")
- ✅ Фильтрует по размерам ("6000", "150x150")
- ✅ Фильтрует по классу ("АВ", "С")
- ✅ Работает с синонимами ("евровагонка" → "вагонка")
- ✅ Нормализует единицы ("6м" → "6000")

### Non-Functional Requirements
- ⚡ Latency < 300ms (end-to-end)
- 🎯 Precision@5 > 80%
- 🔄 Cache hit rate > 90%
- 📉 Zero results < 10%
- 🚀 Scalable до 10,000 товаров

---

## 🔮 Future: Hybrid Search (Phase 2)

```
┌─────────────────────────────────────────────────────────────┐
│  Query: "чем обшить баню внутри?"                            │
└─────────────────────────────────────────────────────────────┘
                           ↓
              ┌────────────┴────────────┐
              ↓                         ↓
     ┌────────────────┐        ┌────────────────┐
     │  BM25 Path     │        │  Vector Path   │
     │  keywords:     │        │  embedding     │
     │  [баня, внутри]│        │  semantic      │
     └────────┬───────┘        └───────┬────────┘
              │                        │
              ↓                        ↓
     ┌────────────────┐        ┌────────────────┐
     │  Top-50        │        │  Top-50        │
     │  by BM25       │        │  by cosine     │
     └────────┬───────┘        └───────┬────────┘
              │                        │
              └────────────┬───────────┘
                           ↓
              ┌────────────────────────┐
              │  Reciprocal Rank       │
              │  Fusion (RRF)          │
              └────────────┬───────────┘
                           ↓
              ┌────────────────────────┐
              │  Top-20 Final          │
              │  1. Вагонка липа       │
              │  2. Вагонка осина      │
              │  3. Полок липа         │
              └────────────────────────┘
```

---

**Создано**: 2026-01-18
**Обновлено**: 2026-01-18
**Версия**: 1.0
