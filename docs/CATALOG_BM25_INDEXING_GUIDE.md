# Руководство по индексации каталога товаров для BM25

## Обзор данных

- **Всего записей:** 861 товар
- **Всего колонок:** 34 поля
- **Дубликаты:** 148 строк (17.19%) - одинаковые `item_code` с разными единицами измерения

## Структура данных

### Основные идентификаторы (100% заполнены)

| Поле | Значение | Уникальных | Использование |
|------|----------|------------|---------------|
| `item_code` | Код товара в 1С | 713 | **Ключ для поиска цен и остатков** |
| `group_code` | Код группы товаров | 30 | Группировка по категориям |
| `group_name` | Название группы | 30 | Категория товара |

### Поля для полнотекстового поиска (BM25)

#### Приоритет 1: Основные названия (95-100% заполнены)

1. **`item_name`** (100% заполнено, 713 уникальных)
   - Короткое название товара
   - Пример: "Вагонка штиль стр. сух. хв. 13х115х6000 класс С"
   - **Использование:** Основное поле для BM25 индексации

2. **`Наименование`** (99.7% заполнено, 710 уникальных)
   - Полное русское название
   - Почти идентично `item_name`, но иногда более подробное
   - **Использование:** Дополнительное поле для поиска

3. **`Наименованиедлясайта`** (97% заполнено, 659 уникальных)
   - Название для сайта (более читаемое)
   - Пример: "Вагонка штиль строганая сухая хвоя 13х115х6000 класс АВ"
   - **Использование:** Приоритетное поле - содержит нормализованные термины

#### Приоритет 2: Категориальные поля для фильтрации

4. **`Видпиломатериала`** (99.7% заполнено, 22 уникальных)
   - Тип пиломатериала
   - **Значения:** Доска, Брус, Брусок, Вагонка штиль, Евровагонка, Европол, Имитация бруса, Блок Хаус, Планкен, и др.
   - **Использование:** Фильтр + поиск по типу

5. **`Порода`** (98.1% заполнено, 6 уникальных)
   - Порода дерева
   - **Значения:** хвоя (664), лиственница (79), осина (44), липа, сосна, ель
   - **Использование:** Фильтр по породе дерева

6. **`Сорт`** (95.3% заполнено, 11 уникальных)
   - Класс качества
   - **Значения:** класс АВ, класс С, класс А, класс Экстра, класс Прима, сорт 1/2/4 ГОСТ/ТУ
   - **Использование:** Фильтр по качеству

### Технические характеристики (для структурированного поиска)

7. **`Толщина`** (99.7% заполнено, 36 уникальных)
   - Толщина в мм: 12, 13, 14, 16, 18, 20, 21, 25, 28, 36, 40, 45, 50, и др.
   - **Использование:** Числовой фильтр/поиск

8. **`Ширина`** (99.7% заполнено, 30 уникальных)
   - Ширина в мм: 90, 100, 110, 115, 120, 140, 150, 180, 190, 200, и др.
   - **Использование:** Числовой фильтр/поиск

9. **`Длина`** (99.7% заполнено, 15 уникальных)
   - Длина в мм: 900, 1500, 2000, 2500, 2700, 3000, 4000, 5000, 6000, 7000
   - **Использование:** Числовой фильтр/поиск

10. **`Влажность`** (98.1% заполнено, 3 уникальных)
    - **Значения:** сухой 12-14%, естественной влажности 23-65%, сырой 23-65%
    - **Использование:** Фильтр по влажности

11. **`Типобработки`** (98.1% заполнено, 2 уникальных)
    - **Значения:** строганый (549), обрезной (296)
    - **Использование:** Фильтр по обработке

### Коммерческие данные

12. **`Цена`** (99.7% заполнено, 92 уникальных)
    - Цена в рублях: 11000, 22000, 23000, 26000, 27000, и др.
    - **Использование:** Фильтр по цене, сортировка

13. **`Остаток`** (99.7% заполнено, 198 уникальных)
    - Остаток на складе
    - **Значения:** "По предзаказу" (585), числовые значения (11 325, 743, и др.)
    - **Использование:** Фильтр наличия, сортировка

### Дополнительные поля (частично заполнены)

14. **`СрокпроизводстваднОбщие`** (94.7% заполнено, 10 уникальных)
    - Срок производства в днях: 1, 2, 3, 4, 5, 6, 7, 10, 14, 25
    - **Использование:** Фильтр по срокам

15. **`ПопулярностьОбщие`** (77.5% заполнено, 6 уникальных)
    - Оценка популярности: 0, 1, 2, 3, 4, 5
    - **Использование:** Сортировка по популярности

16. **`Плотностькгм3Общие`** (99.7% заполнено, 11 уникальных)
    - Плотность в кг/м³: 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950
    - **Использование:** Техническая характеристика

## Рекомендации по индексации BM25

### Структура документа для индексации

```python
{
    "id": "item_code",  # Уникальный идентификатор
    "text": "combined_searchable_text",  # Объединенный текст для поиска
    "metadata": {
        # Поля для фильтрации
        "type": "Видпиломатериала",
        "species": "Порода",
        "grade": "Сорт",
        "moisture": "Влажность",
        "treatment": "Типобработки",
        # Числовые поля для диапазонов
        "thickness": float("Толщина"),
        "width": float("Ширина"),
        "length": float("Длина"),
        "price": float("Цена"),
        "stock": "Остаток",
        # Дополнительные
        "group_name": "group_name",
        "production_days": float("СрокпроизводстваднОбщие"),
        "popularity": float("ПопулярностьОбщие"),
    }
}
```

### Формирование поискового текста

**Рекомендуемая комбинация полей для `text`:**

```python
searchable_text = " ".join([
    item.get("Наименованиедлясайта", ""),  # Приоритет 1
    item.get("item_name", ""),              # Приоритет 2
    item.get("Наименование", ""),           # Приоритет 3
    item.get("Видпиломатериала", ""),       # Тип товара
    item.get("Порода", ""),                 # Порода дерева
    item.get("Сорт", ""),                   # Класс качества
])
```

**Почему именно так:**
- `Наименованиедлясайта` содержит нормализованные термины ("строганая" вместо "стр.")
- `item_name` содержит компактное описание с размерами
- Остальные поля добавляют контекст для лучшего понимания запросов

### Веса полей для BM25

```python
FIELD_WEIGHTS = {
    "Наименованиедлясайта": 3.0,  # Высокий вес - нормализованный текст
    "item_name": 2.5,              # Высокий вес - основное название
    "Наименование": 2.0,           # Средний вес
    "Видпиломатериала": 1.5,       # Средний вес - категория
    "Порода": 1.0,                 # Низкий вес - фильтр
    "Сорт": 1.0,                   # Низкий вес - фильтр
}
```

## Паттерны в данных

### Дубликаты

- **148 дубликатов (17.19%)** - одинаковые `item_code`
- **Причина:** Разные единицы измерения (м², м³, шт) для одного товара
- **Решение:** При индексации объединять или индексировать отдельно с пометкой единицы измерения

### Пустые поля и условия

#### Полностью пустые (не использовать):
- `Код` - 100% пусто
- `Дополнительнаяедизмерения3Общие` - 100% пусто

#### Почти пустые (игнорировать):
- `РегионОбщие` - 99.77% пусто (только 2 значения "Харовск")
- `СпециальныеценыОбщие` - 99.54% пусто (только 4 значения "Акция")
- `Допсвойство` - 99.19% пусто (только 7 значений)

#### Частично заполненные (использовать с осторожностью):
- `Класс` - 79.33% пусто (дублирует `Сорт`)
- `Дополнительнаяедизмерения2` - 70.73% пусто
- `ЕГАИСОбщие` - 50.99% пусто (только для обработанных консервантом)
- `КоличествовупаковкеОбщие` - 47.5% пусто

### Корреляции пустых полей

**Важное наблюдение:** Когда `Наименование` пусто (3 случая), также пусты:
- `Цена`
- `Остаток`
- `Видпиломатериала`
- `Порода`
- `Толщина`, `Ширина`, `Длина`

**Вывод:** Эти 3 записи - неполные данные, можно исключить из индексации или обработать отдельно.

## Рекомендации для агента

### Структура запросов к BM25

Агент должен уметь:

1. **Извлекать параметры из запроса:**
   - Тип товара: "вагонка", "брус", "доска"
   - Порода: "хвоя", "липа", "лиственница"
   - Размеры: "13х115х6000", "толщина 20", "ширина 140"
   - Класс: "класс АВ", "класс С", "сорт 1"
   - Влажность: "сухой", "естественной влажности"

2. **Формировать поисковый запрос:**
   ```python
   query = {
       "text": "вагонка штиль хвоя 13 115 6000 класс АВ",  # BM25 поиск
       "filters": {
           "type": "Вагонка штиль",
           "species": "хвоя",
           "grade": "класс АВ",
           "thickness": 13,
           "width": 115,
           "length": 6000,
       }
   }
   ```

3. **Обрабатывать синонимы:**
   - "вагонка" = "Вагонка штиль" или "Евровагонка"
   - "хвоя" = "сосна" или "ель" (хвойные породы)
   - "сухой" = "сухой 12-14%"
   - "строганый" = "строганая"

### Примеры запросов для обучения

1. **Точный поиск:**
   - "вагонка 13х115х6000 класс АВ"
   - Ожидаемый результат: точное совпадение по размерам и классу

2. **Поиск по типу:**
   - "вагонка для бани"
   - Ожидаемый результат: вагонка из липы или осины (подходит для бани)

3. **Поиск по размеру:**
   - "брус 150х150"
   - Ожидаемый результат: брус с шириной и толщиной 150мм

4. **Поиск по цене:**
   - "вагонка до 25000 рублей"
   - Ожидаемый результат: фильтрация по цене <= 25000

5. **Комбинированный:**
   - "сухая строганая доска хвоя 6 метров"
   - Ожидаемый результат: доска, влажность "сухой 12-14%", обработка "строганый", порода "хвоя", длина 6000

## План индексации

### Этап 1: Базовая индексация (MVP)

1. Создать индекс из объединенного текста:
   ```
   Наименованиедлясайта + item_name + Наименование + Видпиломатериала + Порода + Сорт
   ```

2. Добавить метаданные для фильтрации:
   - type, species, grade, moisture, treatment
   - thickness, width, length (числовые)
   - price, stock

3. Реализовать BM25 поиск с весами полей

### Этап 2: Расширенная индексация

1. Добавить синонимы в индекс:
   - "вагонка" → ["вагонка штиль", "евровагонка"]
   - "хвоя" → ["сосна", "ель", "хвоя"]
   - "сухой" → ["сухой 12-14%"]

2. Нормализация размеров:
   - "6м" → "6000"
   - "13х115" → "13 115"

3. Поддержка диапазонов:
   - "толщина 20-30" → фильтр 20 <= thickness <= 30

### Этап 3: Гибридный поиск (будущее)

1. Добавить векторный поиск для семантики
2. Reranking с учетом бизнес-логики (наличие, популярность)
3. Обучение на реальных запросах пользователей

## Технические детали

### Обработка дубликатов

**Вариант 1:** Индексировать все варианты с пометкой единицы измерения
```python
{
    "id": "00-00010232-м2",
    "text": "...",
    "unit": "м2",
    "coefficient": 0.42
}
```

**Вариант 2:** Индексировать один раз, хранить все единицы в метаданных
```python
{
    "id": "00-00010232",
    "text": "...",
    "units": {
        "м2": {"coefficient": 0.42, "quantity": 2.38},
        "м3": {"coefficient": 0.0118, "quantity": 21.258}
    }
}
```

**Рекомендация:** Вариант 2 - проще для пользователя, один результат с выбором единицы измерения.

### Нормализация текста

1. **Приведение к нижнему регистру**
2. **Удаление лишних пробелов**
3. **Нормализация размеров:**
   - "3 000" → "3000"
   - "12,5" → "12.5"
4. **Разделение составных слов:**
   - "Вагонкаштиль" → "Вагонка штиль"

### Индексация чисел

Числовые поля (толщина, ширина, длина, цена) должны индексироваться:
1. Как текст для BM25 (для поиска "вагонка 13")
2. Как числа для фильтрации (для диапазонов "толщина 20-30")

## Метрики качества

После индексации проверить:

1. **Precision@10:** Точность топ-10 результатов
2. **Recall@20:** Полнота покрытия релевантных товаров
3. **Latency:** Время ответа < 50ms
4. **Coverage:** Все 861 товар проиндексирован

## Следующие шаги

1. ✅ Анализ данных (выполнено)
2. ⏳ Создание индексатора BM25
3. ⏳ Интеграция в tool `search_products`
4. ⏳ Тестирование на реальных запросах
5. ⏳ Оптимизация весов и фильтров
