# BM25 Search Implementation - Complete Guide

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–í–Ω–µ–¥—Ä–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∏—Å–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ BM25 –¥–ª—è –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∞–≥–µ–Ω—Ç–∞:

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

1. **BM25 –ø–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É —Ç–æ–≤–∞—Ä–æ–≤** ([backend/tools/product_search_bm25.py](backend/tools/product_search_bm25.py))
   - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ CSV
   - BM25 —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –ø–æ–ª—è–º: `item_name`, `–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ`, `–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ–¥–ª—è—Å–∞–π—Ç–∞`
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, —Ä–∞–∑–º–µ—Ä–∞–º, —Ü–µ–Ω–µ, –Ω–∞–ª–∏—á–∏—é

2. **BM25 –ø–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π** ([backend/tools/search_company_info.py](backend/tools/search_company_info.py))
   - BM25 –ø–æ keywords + title + content
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç top-3 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–∞

3. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ 1–°** ([backend/tools/get_product_live_details.py](backend/tools/get_product_live_details.py))
   - –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ 1–° API `GetDetailedItems`
   - –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∏ –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ

### üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ

- `search_1c_products.py` - legacy 1C search
- `search_products.py` - legacy product search
- `get_product_details.py` - legacy details
- `product_search_typed.py` - hardcoded Literal types
- `catalog_categories.json` - —Å—Ç–∞—Ç–∏—á–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–∏—Å–∫–∞

```
User Query
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. search_products_tool             ‚îÇ  –ü–µ—Ä–≤–∏—á–Ω—ã–π –ø–æ–∏—Å–∫
‚îÇ    (BM25 –ø–æ CSV –∫–∞—Ç–∞–ª–æ–≥—É)          ‚îÇ  –ø–æ offline –¥–∞–Ω–Ω—ã–º
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
    ‚îú‚îÄ –§–∏–ª—å—Ç—Ä—ã: –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Ä–∞–∑–º–µ—Ä—ã, —Ü–µ–Ω–∞
    ‚îú‚îÄ BM25 –ø–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–º –ø–æ–ª—è–º
    ‚îú‚îÄ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—Ç top-20 —Ç–æ–≤–∞—Ä–æ–≤ —Å –∫–æ–¥–∞–º–∏

    ‚Üì (–µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è)

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. get_product_live_details         ‚îÇ  –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îÇ    (1–° API GetDetailedItems)        ‚îÇ  –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ç–æ–≤–∞—Ä—É
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
    ‚îú‚îÄ –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∏–∑ 1–°
    ‚îú‚îÄ –†–µ–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ
    ‚îú‚îÄ –°—Ä–æ–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
    ‚îî‚îÄ –ü–æ–ª–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–º

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–±—â–∏–π –ø–æ–∏—Å–∫

```
User: "–ü–æ–∫–∞–∂–∏—Ç–µ –≤–∞–≥–æ–Ω–∫—É –∫–ª–∞—Å—Å–∞ –ê–í"
Agent:
  1. –í—ã–∑—ã–≤–∞–µ—Ç search_products_tool(material_type="–í–∞–≥–æ–Ω–∫–∞", grade="–∫–ª–∞—Å—Å –ê–í")
  2. –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å BM25 scores
  3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É top-5
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä + –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞

```
User: "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –≤–∞–≥–æ–Ω–∫–∞ —à—Ç–∏–ª—å 13—Ö115—Ö6000 –∫–ª–∞—Å—Å –ê–í?"
Agent:
  1. search_products_tool(query="–≤–∞–≥–æ–Ω–∫–∞ —à—Ç–∏–ª—å", thickness_min=13, thickness_max=13, ...)
  2. –ù–∞—Ö–æ–¥–∏—Ç —Ç–æ–≤–∞—Ä —Å –∫–æ–¥–æ–º "00-00010232"
  3. get_product_live_details(item_codes="00-00010232")
  4. –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É: 22000 —Ä—É–±, –æ—Å—Ç–∞—Ç–æ–∫: –ü–æ –ø—Ä–µ–¥–∑–∞–∫–∞–∑—É
  5. –û—Ç–≤–µ—á–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏

```
User: "–ö–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è –¥–æ —Å–∫–ª–∞–¥–∞?"
Agent:
  1. search_company_info(query="–∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è –¥–æ —Å–∫–ª–∞–¥–∞")
  2. BM25 –Ω–∞—Ö–æ–¥–∏—Ç —Ä–∞–∑–¥–µ–ª "contacts" (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: 8.45)
  3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–¥—Ä–µ—Å, –∫–∞—Ä—Ç—É, –≤–∏–¥–µ–æ-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
```

## –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–≥–µ–Ω—Ç–∞

| Tool | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö |
|------|-----------|-----------------|
| `search_products_tool` | –ü–µ—Ä–≤–∏—á–Ω—ã–π –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ | CSV (offline, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑ –≤ —á–∞—Å) |
| `get_product_live_details` | –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞/–æ—Å—Ç–∞—Ç–æ–∫ | 1–° API (real-time) |
| `search_company_info` | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏ | –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (JSON) |
| `call_manager` | –í—ã–∑–æ–≤ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ | - |
| `collect_order_info` | –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–∫–∞–∑–∞ | - |

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### CSV –∫–∞—Ç–∞–ª–æ–≥

–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º [export_1c_catalog_to_csv.py](../export_1c_catalog_to_csv.py):

```bash
python export_1c_catalog_to_csv.py
# –°–æ–∑–¥–∞—Å—Ç: 1c_catalog_full_20260118_201417.csv
```

–ê–≥–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π CSV –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.

### 1C API

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env`:

```env
C1_DETAILED_API_URL="http://172.16.77.34/stroyast_test/hs/Ai/GetDetailedItems"
C1_API_USER="Admin"
C1_API_PASSWORD="789654"
C1_API_TIMEOUT_SECONDS=30
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è | –ö—ç—à |
|----------|-------|-----|
| –ó–∞–≥—Ä—É–∑–∫–∞ CSV (861 —Å—Ç—Ä–æ–∫) | ~100ms | –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ |
| BM25 –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è | ~50ms | Per query |
| BM25 –ø–æ–∏—Å–∫ | <10ms | - |
| 1C API –∑–∞–ø—Ä–æ—Å | 200-500ms | –ù–µ—Ç |
| KB –ø–æ–∏—Å–∫ (BM25) | <5ms | - |

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```toml
"pandas>=2.2.0",
"rank-bm25>=0.2.2",
```

–£—Å—Ç–∞–Ω–æ–≤–∫–∞:

```bash
cd backend
uv sync
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤

```bash
cd backend
source .venv/bin/activate
python tools/product_search_bm25.py
```

### –¢–µ—Å—Ç live –¥–∞–Ω–Ω—ã—Ö –∏–∑ 1–°

```bash
python -c "
from tools.get_product_live_details import get_product_live_details
result = get_product_live_details('00-00010232')
print(result)
"
```

### –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π

```bash
python -c "
from tools.search_company_info import search_company_info
result = search_company_info('–∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è')
print(result)
"
```

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞:
```bash
python export_1c_catalog_to_csv.py
```

2. –û–±–Ω–æ–≤–∏—Ç—å –ø—É—Ç—å –≤ `product_search_bm25.py` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
```python
def load_catalog(csv_path: str = "1c_catalog_full_–ù–û–í–ê–Ø_–î–ê–¢–ê.csv"):
```

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≥–µ–Ω—Ç–∞ - –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±–Ω–æ–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ CSV –≤ Redis
- [ ] –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è BM25 –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–∏—Å–∫–∞
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ BM25 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
consultant/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ tools/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product_search_bm25.py      # BM25 –ø–æ–∏—Å–∫ –ø–æ CSV
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get_product_live_details.py # 1C API –∑–∞–ø—Ä–æ—Å—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ search_company_info.py      # BM25 –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ agent.py                        # –û—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ BM25_SEARCH_IMPLEMENTATION.md   # –≠—Ç–æ—Ç —Ñ–∞–π–ª
‚îÇ   ‚îî‚îÄ‚îÄ PRODUCT_SEARCH_README.md        # –î–µ—Ç–∞–ª–∏ product_search
‚îú‚îÄ‚îÄ 1c_catalog_full_*.csv               # –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤
‚îî‚îÄ‚îÄ export_1c_catalog_to_csv.py         # –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```
